' Subroutine to launch the UserForm from an Excel button
Public Sub ShowExtractorForm()
    ' Make sure your UserForm is named UserForm1 or change the name here
    UserForm1.Show
End Sub

' Main Subroutine called from the UserForm to process emails
Public Sub ParseOutlookEmails(ByVal hoursBack As Integer)

    ' --- Variable Declarations ---
    Dim olApp As Object 'Outlook.Application
    Dim olNamespace As Object 'Outlook.Namespace
    Dim olFolder As Object 'Outlook.MAPIFolder
    Dim olMail As Object
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim filterTime As Date
    Dim mailCount As Integer

    ' --- Setup ---
    Set ws = ThisWorkbook.Sheets("Email Data")
    mailCount = 0
    
    ' Clear previous data but keep headers
    ws.Rows("2:" & ws.Rows.Count).ClearContents
    lastRow = 2 ' Start populating data from row 2
    
    ' Calculate the cutoff time for email search
    filterTime = DateAdd("h", -hoursBack, Now)

    ' --- Connect to Outlook ---
    On Error Resume Next
    Set olApp = GetObject(, "Outlook.Application")
    If olApp Is Nothing Then
        Set olApp = CreateObject("Outlook.Application")
    End If
    On Error GoTo 0
    
    If olApp Is Nothing Then
        MsgBox "Outlook is not running. Please open Outlook and try again.", vbCritical, "Outlook Connection Error"
        Exit Sub
    End If
    
    Set olNamespace = olApp.GetNamespace("MAPI")
    Set olFolder = olNamespace.GetDefaultFolder(6) ' 6 corresponds to the Inbox folder

    ' --- Loop Through Emails and Extract Data ---
    For Each olMail In olFolder.Items
        ' Apply filters: Time, Sender, and Subject
        If olMail.ReceivedTime >= filterTime Then
            If LCase(olMail.SenderEmailAddress) = "erp@example.com" And olMail.Subject Like "Deal * with probability *" Then
                
                ' Extract data using the helper function
                Dim dealID As String, probability As String, clientName As String
                Dim dealName As String, lob As String, pmName As String, oppID As String
                
                dealID = ExtractData(olMail.Body, "Deal ID", vbCrLf)
                probability = ExtractData(olMail.Body, "with a ", " probability")
                clientName = ExtractData(olMail.Subject, "proposal for ", " for ")
                dealName = Trim(Mid(olMail.Subject, InStr(1, olMail.Subject, "project titled", vbTextCompare) + Len("project titled")))
                lob = ExtractData(olMail.Body, "has been allocated to ", ".")
                pmName = ExtractData(olMail.Body, lob & ". ", " is managing the project.")
                oppID = ExtractData(olMail.Body, "Oppotunity ID", vbCrLf)
                
                ' Write data to the Excel sheet
                ws.Cells(lastRow, 1).Value = dealID
                ws.Cells(lastRow, 2).Value = probability
                ws.Cells(lastRow, 3).Value = clientName
                ws.Cells(lastRow, 4).Value = dealName
                ws.Cells(lastRow, 5).Value = lob
                ws.Cells(lastRow, 6).Value = pmName
                ws.Cells(lastRow, 7).Value = oppID
                
                lastRow = lastRow + 1
                mailCount = mailCount + 1
            End If
        End If
    Next olMail

    ' --- Cleanup and Final Message ---
    Set olMail = Nothing
    Set olFolder = Nothing
    Set olNamespace = Nothing
    Set olApp = Nothing
    
    MsgBox mailCount & " new deals have been successfully extracted and added to the sheet.", vbInformation, "Extraction Complete"

End Sub

' Helper function to extract text between two strings
Private Function ExtractData(ByVal sourceText As String, ByVal startDelimiter As String, ByVal endDelimiter As String) As String
    Dim posStart As Long, posEnd As Long
    
    ' Find the starting position of the text
    posStart = InStr(1, sourceText, startDelimiter, vbTextCompare)
    
    If posStart > 0 Then
        ' Find the ending position of the text, starting after the startDelimiter
        posEnd = InStr(posStart + Len(startDelimiter), sourceText, endDelimiter, vbTextCompare)
        
        If posEnd > 0 Then
            ' If both delimiters are found, extract the text between them
            ExtractData = Trim(Mid(sourceText, posStart + Len(startDelimiter), posEnd - (posStart + Len(startDelimiter))))
        Else 
            ' Handles cases where the end delimiter is a newline or end of text
            ExtractData = Trim(Mid(sourceText, posStart + Len(startDelimiter)))
        End If
    Else
        ' If the start delimiter isn't found, return an error message
        ExtractData = "Not Found"
    End If
End Function






Option Explicit

Sub ParseDealMails()
    Dim OutlookApp As Object
    Dim OutlookNs As Object
    Dim Inbox As Object
    Dim Items As Object
    Dim Mail As Object
    Dim i As Long, RowNum As Long
    Dim DealID As String, Probability As String
    Dim ClientName As String, DealName As String
    Dim LOB As String, PMName As String
    Dim OppID As String
    Dim SubjectText As String, BodyText As String
    Dim FilterHours As Double
    Dim MailDate As Date
    
    ' ===== User settings =====
    Const SenderAddress As String = "erp@example.com"
    FilterHours = 4    ' Change this for how many hours back
    
    ' ===== Initialize Outlook =====
    On Error Resume Next
    Set OutlookApp = GetObject(, "Outlook.Application")
    If OutlookApp Is Nothing Then
        Set OutlookApp = CreateObject("Outlook.Application")
    End If
    On Error GoTo 0
    
    Set OutlookNs = OutlookApp.GetNamespace("MAPI")
    Set Inbox = OutlookNs.GetDefaultFolder(6) ' 6 = Inbox
    Set Items = Inbox.Items
    Items.Sort "ReceivedTime", True
    
    ' ===== Find next empty row =====
    With ThisWorkbook.Sheets("Sheet1")
        RowNum = .Cells(.Rows.Count, 1).End(xlUp).Row + 1
    End With
    
    ' ===== Loop mails =====
    For i = Items.Count To 1 Step -1
        Set Mail = Items(i)
        If Mail.Class = 43 Then ' Only mail items
            MailDate = Mail.ReceivedTime
            
            If MailDate >= Now - (FilterHours / 24) Then
                If LCase(Mail.SenderEmailAddress) Like "*" & LCase(SenderAddress) & "*" Then
                    SubjectText = Mail.Subject
                    BodyText = Mail.Body
                    
                    ' ==== Parse fields ====
                    DealID = ExtractBetween(BodyText, "Deal ID", vbCrLf)
                    Probability = ExtractBetween(SubjectText, "with probability", "")
                    If Probability = "" Then Probability = ExtractBetween(SubjectText, "with a", "probability")
                    ClientName = ExtractBetween(SubjectText, "proposal for", "for")
                    DealName = ExtractBetween(SubjectText, "project titled", "")
                    LOB = ExtractBetween(BodyText, "has been allocated to", ".")
                    PMName = ExtractBetween(BodyText, LOB & " ", " is managing the project")
                    OppID = ExtractBetween(BodyText, "Oppotunity ID", vbCrLf)
                    
                    ' ==== Write to Excel ====
                    With ThisWorkbook.Sheets("Sheet1")
                        .Cells(RowNum, 1).Value = MailDate
                        .Cells(RowNum, 2).Value = Trim(DealID)
                        .Cells(RowNum, 3).Value = Trim(Probability)
                        .Cells(RowNum, 4).Value = Trim(ClientName)
                        .Cells(RowNum, 5).Value = Trim(DealName)
                        .Cells(RowNum, 6).Value = Trim(LOB)
                        .Cells(RowNum, 7).Value = Trim(PMName)
                        .Cells(RowNum, 8).Value = Trim(OppID)
                    End With
                    RowNum = RowNum + 1
                End If
            Else
                Exit For ' Older than required hours
            End If
        End If
    Next i
    
    MsgBox "Parsing complete. Data appended till row " & (RowNum - 1)
End Sub

Private Function ExtractBetween(ByVal Text As String, ByVal StartWord As String, ByVal EndWord As String) As String
    Dim StartPos As Long, EndPos As Long
    StartPos = InStr(1, Text, StartWord, vbTextCompare)
    If StartPos > 0 Then
        StartPos = StartPos + Len(StartWord)
        If EndWord <> "" Then
            EndPos = InStr(StartPos, Text, EndWord, vbTextCompare)
            If EndPos > 0 Then
                ExtractBetween = Mid(Text, StartPos, EndPos - StartPos)
            Else
                ExtractBetween = Mid(Text, StartPos)
            End If
        Else
            ExtractBetween = Mid(Text, StartPos)
        End If
    Else
        ExtractBetween = ""
    End If
End Function
